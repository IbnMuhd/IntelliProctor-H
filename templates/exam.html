{% extends "base.html" %}
{% block title %}Exam - Proctoring{% endblock %}
{% block content %}
<div style="max-width:700px;margin:24px auto 0 auto;">
  <div style="background:#eaf2ff;border-radius:8px;padding:16px 20px 10px 20px;margin-bottom:18px;text-align:center;">
    <span style="font-size:1.1em;color:#2356c7;font-weight:600;">Course Code:</span> <span style="font-size:1.1em;">{{ course_code }}</span>
    <span style="margin-left:18px;font-size:1.1em;color:#2356c7;font-weight:600;">Exam:</span> <span style="font-size:1.1em;">{{ exam_title }}</span>
  </div>
</div>
<h2>Exam</h2>
<div style="background: #f8f9fa; border-radius: 10px; padding: 24px; margin-bottom: 28px; max-width: 700px; margin-left: auto; margin-right: auto; box-shadow: 0 2px 8px rgba(0,0,0,0.07);">
    <h3 style="color: #4f8cff; margin-bottom: 10px;">Exam Instructions</h3>
    <ul style="font-size: 1.05em; color: #222; padding-left: 20px;">
        <li>Your exam session is being monitored using AI proctoring technology.</li>
        <li>Your camera, microphone, and screen activity are being observed throughout the exam.</li>
        <li>Remain in front of your camera and avoid looking away from the screen.</li>
        <li>Do not leave or minimize the exam window; doing so may trigger alerts.</li>
        <li>Any suspicious behavior (such as multiple faces, background noise, or use of a phone) will be flagged and reported to the administrator.</li>
        <li>If you experience technical issues, contact support immediately.</li>
    </ul>
</div>
<div style="text-align:center; margin-bottom:32px;">
    <button id="startExamBtn" class="btn btn-login" style="font-size:1.2em; padding:16px 36px;">Start Exam</button>
    <span id="startExamSpinner" style="display:none; margin-left:12px; vertical-align:middle;">
        <span class="spinner" style="display:inline-block; width:22px; height:22px; border:3px solid #4f8cff; border-top:3px solid #fff; border-radius:50%; animation:spin 1s linear infinite;"></span>
    </span>
    <div id="startExamMsg" style="margin-top:10px; font-size:1em;"></div>
</div>
<style>
@keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg);} }
</style>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const btn = document.getElementById('startExamBtn');
    const spinner = document.getElementById('startExamSpinner');
    const msg = document.getElementById('startExamMsg');
    if(btn) {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            btn.disabled = true;
            spinner.style.display = 'inline-block';
            msg.textContent = '';
            fetch('/start_exam', {method: 'POST'})
                .then(async res => {
                    spinner.style.display = 'none';
                    let data;
                    try {
                        data = await res.json();
                    } catch (e) {
                        data = {};
                    }
                    if(res.ok && data.status === 'success' && data.redirect) {
                        msg.style.color = '#28a745';
                        msg.textContent = 'Exam started! Redirecting...';
                        setTimeout(() => { window.location.href = data.redirect; }, 1000);
                    } else {
                        btn.disabled = false;
                        msg.style.color = '#d9534f';
                        msg.textContent = (data && data.message) ? data.message : ('Failed to start exam.' + (res.status ? ' (Error ' + res.status + ')' : ''));
                    }
                })
                .catch(err => {
                    spinner.style.display = 'none';
                    btn.disabled = false;
                    msg.style.color = '#d9534f';
                    msg.textContent = 'Network error. Please try again.';
                });
        });
    }
});
</script>
<!-- Proctoring video feed removed from exam.html; now only shown on exam_questions.html -->
<div id="proctorModal" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(44,62,80,0.75); z-index:2000; align-items:center; justify-content:center;">
    <div style="background:#fff; border-radius:12px; padding:32px 28px; max-width:400px; margin:auto; text-align:center; box-shadow:0 4px 24px rgba(0,0,0,0.18);">
        <h3 style="color:#4f8cff;">Proctoring System Active</h3>
        <p>Your exam session is now being monitored by the AI proctoring system. Your camera, microphone, and screen activity will be observed for the duration of the exam. Please ensure you are alone, avoid suspicious behavior, and do not leave the exam window.</p>
        <button id="closeModal" style="margin-top:18px;">I Understand</button>
    </div>
</div>
<script>
    // Show proctoring modal on load
    document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('proctorModal').style.display = 'flex';
    });
    const closeModalBtn = document.getElementById('closeModal');
    if(closeModalBtn) {
        closeModalBtn.addEventListener('click', function() {
            document.getElementById('proctorModal').style.display = 'none';
        });
    }
</script>
{% endblock %}
